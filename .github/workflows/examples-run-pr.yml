name: Sync Examples to GitHub Pages - PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'inst/examples/output/**'
      - '.github/workflows/examples-run-pr.yml'

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  sync-examples:
    runs-on: ubuntu-latest
    outputs:
      has_outputs: ${{ steps.check-outputs.outputs.has_outputs }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for example outputs
        id: check-outputs
        run: |
          if [ ! -d "inst/examples/output" ] || [ -z "$(find inst/examples/output -name '*.html')" ]; then
            echo "No HTML files found in inst/examples/output"
            echo "has_outputs=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "has_outputs=true" >> $GITHUB_OUTPUT
          echo "Found HTML example outputs:"
          find inst/examples/output -name '*.html'
      
      - name: Copy HTML files to temp location
        if: steps.check-outputs.outputs.has_outputs == 'true'
        run: |
          mkdir -p /tmp/examples
          find inst/examples/output -name '*.html' -exec cp {} /tmp/examples/ \;
          echo "Files copied to temp:"
          ls -la /tmp/examples/
      
      - name: Checkout gh-pages branch
        if: steps.check-outputs.outputs.has_outputs == 'true'
        run: |
          git fetch origin gh-pages:gh-pages
          git checkout gh-pages
      
      - name: Copy example outputs to gh-pages
        if: steps.check-outputs.outputs.has_outputs == 'true'
        run: |
          # Create PR-specific directory
          mkdir -p "examples/pr-${{ github.event.pull_request.number }}"
          
          # Copy HTML files from temp location
          cp /tmp/examples/*.html "examples/pr-${{ github.event.pull_request.number }}/"
          
          echo "Contents of examples/pr-${{ github.event.pull_request.number }}/:"
          ls -la "examples/pr-${{ github.event.pull_request.number }}/" || echo "No files copied"
      
      - name: Commit examples (no push)
        if: steps.check-outputs.outputs.has_outputs == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "examples/pr-${{ github.event.pull_request.number }}/"
          git commit -m "Update examples for PR #${{ github.event.pull_request.number }} from ${{ github.sha }}" || echo "No changes to commit"
  
  generate-index:
    needs: sync-examples
    if: needs.sync-examples.outputs.has_outputs == 'true'
    uses: ./.github/workflows/examples-index.yml
    with:
      examples_dir: 'examples/pr-${{ github.event.pull_request.number }}'
  
  push-all:
    needs: [sync-examples, generate-index]
    if: needs.sync-examples.outputs.has_outputs == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
      
      - name: Push all commits to gh-pages
        run: |
          git push origin gh-pages || git push origin gh-pages --force
      
  comment-on-pr:
    needs: [sync-examples, generate-index, push-all]
    if: needs.sync-examples.outputs.has_outputs == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 1
          
      - name: Comment on PR with examples link
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = ${{ github.event.pull_request.number }};
            const examples_url = `https://gilead-biostats.github.io/gsm.kri/examples/pr-${pr_number}/`;
            
            // Check if we have any examples
            const fs = require('fs');
            const path = require('path');
            const examplesDir = `examples/pr-${pr_number}`;
            const mainExamplesDir = 'examples';
            
            let hasExamples = false;
            let exampleFiles = [];
            let mainExampleFiles = [];
            
            try {
              const files = fs.readdirSync(examplesDir);
              exampleFiles = files.filter(f => f.endsWith('.html'));
              hasExamples = exampleFiles.length > 0;
            } catch (e) {
              console.log('No examples directory found for PR');
            }
            
            // Get list of examples from main branch
            try {
              const mainFiles = fs.readdirSync(mainExamplesDir);
              mainExampleFiles = mainFiles.filter(f => f.endsWith('.html') && f !== 'index.html');
            } catch (e) {
              console.log('No main examples directory found');
            }
            
            if (hasExamples) {
              // Identify new examples
              const newExamples = exampleFiles.filter(f => !mainExampleFiles.includes(f));
              const existingExamples = exampleFiles.filter(f => mainExampleFiles.includes(f));
              
              let comment = `## ðŸ“Š Example Outputs\n\nThe examples have been generated and are available at:\n\n${examples_url}\n\n`;
              
              if (newExamples.length > 0) {
                comment += `### ðŸ†• New Examples:\n`;
                newExamples.forEach(file => {
                  const name = file.replace('.html', '');
                  comment += `- [${name}](${examples_url}${file})\n`;
                });
                comment += '\n';
              }
              
              if (existingExamples.length > 0) {
                comment += `### ðŸ”„ Updated Examples:\n`;
                existingExamples.forEach(file => {
                  const name = file.replace('.html', '');
                  comment += `- [${name}](${examples_url}${file})\n`;
                });
                comment += '\n';
              }
              
              comment += `*Examples will be automatically removed when this PR is closed.*`;
              
              // Check if we already commented
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number,
              });
              
              const botComment = comments.find(c => 
                c.user.login === 'github-actions[bot]' && 
                c.body.includes('Example Outputs')
              );
              
              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment,
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr_number,
                  body: comment,
                });
              }
            }
