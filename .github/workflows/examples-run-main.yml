name: Sync Examples to GitHub Pages - Main Branch

on:
  push:
    branches: [main, master]
    paths:
      - 'inst/examples/output/**'
      - '.github/workflows/examples-run-main.yml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  sync-examples:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check for example outputs
        run: |
          if [ ! -d "inst/examples/output" ] || [ -z "$(ls -A inst/examples/output 2>/dev/null)" ]; then
            echo "No example outputs found in inst/examples/output"
            exit 1
          fi
          echo "Found example outputs:"
          ls -la inst/examples/output/
      
      - name: Checkout gh-pages branch
        run: |
          git fetch origin gh-pages:gh-pages 2>/dev/null || git checkout --orphan gh-pages
          git checkout gh-pages 2>/dev/null || git checkout --orphan gh-pages
      
      - name: Copy example outputs to gh-pages
        run: |
          # Create examples directory
          mkdir -p examples
          
          # Copy all files from inst/examples/output
          if [ -d "inst/examples/output" ]; then
            cp -r inst/examples/output/* examples/ 2>/dev/null || true
          fi
          
          echo "Contents of examples/:"
          ls -la examples/ || echo "No files copied"
      
      - name: Create index page
        run: |
          cat > examples/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>gsm.kri Examples</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
              }
              h1 {
                color: #333;
                border-bottom: 3px solid #0366d6;
                padding-bottom: 10px;
              }
              .example-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 30px;
              }
              .example-card {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: transform 0.2s, box-shadow 0.2s;
              }
              .example-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
              }
              .example-card h3 {
                margin-top: 0;
                color: #0366d6;
              }
              .example-card a {
                color: #0366d6;
                text-decoration: none;
                font-weight: 500;
              }
              .example-card a:hover {
                text-decoration: underline;
              }
              .timestamp {
                color: #666;
                font-size: 0.9em;
                margin-top: 20px;
                text-align: center;
              }
            </style>
          </head>
          <body>
            <h1>ðŸ“Š gsm.kri Examples</h1>
            <p>Interactive examples and outputs from the gsm.kri package.</p>
            <div class="example-grid">
          EOF
          
          # Add cards for each HTML file
          for file in examples/*.html; do
            if [ "$file" != "examples/index.html" ] && [ -f "$file" ]; then
              filename=$(basename "$file")
              title="${filename%.html}"
              cat >> examples/index.html << EOF
              <div class="example-card">
                <h3>${title}</h3>
                <p><a href="${filename}">View Example â†’</a></p>
              </div>
          EOF
            fi
          done
          
          cat >> examples/index.html << EOF
            </div>
            <div class="timestamp">
              <p>Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')</p>
              <p><a href="https://github.com/Gilead-BioStats/gsm.kri">View Repository</a></p>
            </div>
          </body>
          </html>
          EOF
    
      - name: Commit and push to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add examples/
          git commit -m "Update examples from ${{ github.sha }}" || echo "No changes to commit"
          git push origin gh-pages || git push origin gh-pages --force
