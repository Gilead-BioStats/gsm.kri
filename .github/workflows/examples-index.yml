name: Generate Examples Index

on:
  workflow_call:
    inputs:
      examples_dir:
        description: 'Directory containing examples (e.g., examples or examples/pr-123)'
        required: true
        type: string

jobs:
  generate-index:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 1
      
      - name: Generate index page
        run: |
          TARGET_DIR="${{ inputs.examples_dir }}"
          
          # Check if directory exists and has HTML files
          if [ ! -d "$TARGET_DIR" ] || [ -z "$(find "$TARGET_DIR" -maxdepth 1 -name '*.html' -not -name 'index.html')" ]; then
            echo "No HTML files found in $TARGET_DIR"
            exit 0
          fi
          
          # Determine title based on directory
          if [[ "$TARGET_DIR" == "examples/pr-"* ]]; then
            PR_NUM=$(echo "$TARGET_DIR" | grep -o 'pr-[0-9]*' | cut -d'-' -f2)
            PAGE_TITLE="gsm.kri Examples - PR #${PR_NUM}"
            BREADCRUMB="<p><a href=\"../index.html\">‚Üê Back to Main Examples</a></p>"
          else
            PAGE_TITLE="gsm.kri Examples"
            BREADCRUMB=""
          fi
          
          cat > "$TARGET_DIR/index.html" << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>PAGE_TITLE_PLACEHOLDER</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
              }
              h1 {
                color: #333;
                border-bottom: 3px solid #0366d6;
                padding-bottom: 10px;
              }
              .breadcrumb {
                margin-bottom: 20px;
              }
              .breadcrumb a {
                color: #0366d6;
                text-decoration: none;
              }
              .breadcrumb a:hover {
                text-decoration: underline;
              }
              .example-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 30px;
              }
              .example-card {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: transform 0.2s, box-shadow 0.2s;
              }
              .example-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
              }
              .example-card h3 {
                margin-top: 0;
                color: #0366d6;
              }
              .example-card a {
                color: #0366d6;
                text-decoration: none;
                font-weight: 500;
              }
              .example-card a:hover {
                text-decoration: underline;
              }
              .timestamp {
                color: #666;
                font-size: 0.9em;
                margin-top: 20px;
                text-align: center;
              }
            </style>
          </head>
          <body>
            <div class="breadcrumb">BREADCRUMB_PLACEHOLDER</div>
            <h1>üìä PAGE_TITLE_PLACEHOLDER</h1>
            <p>Interactive examples and outputs from the gsm.kri package.</p>
            <div class="example-grid">
          EOF
          
          # Replace placeholders
          sed -i "s|PAGE_TITLE_PLACEHOLDER|${PAGE_TITLE}|g" "$TARGET_DIR/index.html"
          sed -i "s|BREADCRUMB_PLACEHOLDER|${BREADCRUMB}|g" "$TARGET_DIR/index.html"
          
          # Add cards for each HTML file
          for file in "$TARGET_DIR"/*.html; do
            if [ "$file" != "$TARGET_DIR/index.html" ] && [ -f "$file" ]; then
              filename=$(basename "$file")
              title="${filename%.html}"
              cat >> "$TARGET_DIR/index.html" << EOF
              <div class="example-card">
                <h3>${title}</h3>
                <p><a href="${filename}">View Example ‚Üí</a></p>
              </div>
          EOF
            fi
          done
          
          cat >> "$TARGET_DIR/index.html" << EOF
            </div>
            <div class="timestamp">
              <p>Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')</p>
              <p><a href="https://github.com/Gilead-BioStats/gsm.kri">View Repository</a></p>
            </div>
          </body>
          </html>
          EOF
          
          echo "Generated index at $TARGET_DIR/index.html"

