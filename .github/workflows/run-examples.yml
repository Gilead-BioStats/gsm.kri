name: Run Examples and Publish to GitHub Pages

on:
  push:
    branches: ['**']
    paths:
      - 'inst/examples/**'
      - '.github/workflows/run-examples.yml'
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - 'inst/examples/**'
      - '.github/workflows/run-examples.yml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  # Job to clean up PR examples when PR is closed
  cleanup-pr-examples:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
      
      - name: Delete PR examples directory
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          if [ -d "examples/pr-${PR_NUMBER}" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git rm -rf "examples/pr-${PR_NUMBER}"
            git commit -m "Clean up examples for PR #${PR_NUMBER}"
            git push origin gh-pages
            echo "Deleted examples/pr-${PR_NUMBER}"
          else
            echo "No examples directory found for PR #${PR_NUMBER}"
          fi

  run-examples:
    if: github.event_name != 'pull_request' || github.event.action != 'closed'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev \
            pandoc
      
      - name: Install R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::devtools
            any::htmlwidgets
            any::dplyr
            any::purrr
            any::tidyr
      
      - name: Create output directory
        run: |
          mkdir -p inst/examples/output
          
      - name: Run example scripts
        run: |
          cd inst/examples
          for script in *.R; do
            if [ -f "$script" ]; then
              echo "Running $script..."
              Rscript "$script" || echo "Warning: $script failed to run completely"
            fi
          done
        continue-on-error: true
        
      - name: List generated files
        run: |
          echo "Files in inst/examples:"
          ls -la inst/examples/
          echo ""
          echo "Files in inst/examples/output (if exists):"
          if [ -d "inst/examples/output" ]; then
            ls -la inst/examples/output/
          fi
      
      - name: Determine target directory
        id: target
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "dir=examples/pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "is_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "dir=examples" >> $GITHUB_OUTPUT
            echo "is_pr=false" >> $GITHUB_OUTPUT
          else
            # For other branches, use branch name
            BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///')
            echo "dir=examples/branch-${BRANCH_NAME}" >> $GITHUB_OUTPUT
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Checkout gh-pages branch
        run: |
          git fetch origin gh-pages:gh-pages 2>/dev/null || git checkout --orphan gh-pages
          git checkout gh-pages 2>/dev/null || git checkout --orphan gh-pages
      
      - name: Copy example outputs to gh-pages
        run: |
          # Create target directory
          mkdir -p "${{ steps.target.outputs.dir }}"
          
          # Copy HTML outputs and other generated files from output directory
          if [ -d "inst/examples/output" ]; then
            cp -r inst/examples/output/* "${{ steps.target.outputs.dir }}/" 2>/dev/null || true
          fi
          
          # Also copy any HTML files directly in inst/examples
          find inst/examples -maxdepth 1 -name "*.html" -exec cp {} "${{ steps.target.outputs.dir }}/" \; 2>/dev/null || true
          
          # Copy any other output files (images, etc.)
          find inst/examples -maxdepth 1 -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.svg" -o -name "*.pdf" \) -exec cp {} "${{ steps.target.outputs.dir }}/" \; 2>/dev/null || true
          
          echo "Contents of ${{ steps.target.outputs.dir }}:"
          ls -la "${{ steps.target.outputs.dir }}/" || echo "No files copied"
      
      - name: Create index page for main branch
        if: steps.target.outputs.is_pr == 'false' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          cat > examples/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>gsm.kri Examples</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
              }
              h1 {
                color: #333;
                border-bottom: 3px solid #0366d6;
                padding-bottom: 10px;
              }
              .example-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 30px;
              }
              .example-card {
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: transform 0.2s, box-shadow 0.2s;
              }
              .example-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
              }
              .example-card h3 {
                margin-top: 0;
                color: #0366d6;
              }
              .example-card a {
                color: #0366d6;
                text-decoration: none;
                font-weight: 500;
              }
              .example-card a:hover {
                text-decoration: underline;
              }
              .timestamp {
                color: #666;
                font-size: 0.9em;
                margin-top: 20px;
                text-align: center;
              }
            </style>
          </head>
          <body>
            <h1>ðŸ“Š gsm.kri Examples</h1>
            <p>Interactive examples and outputs from the gsm.kri package.</p>
            <div class="example-grid">
          EOF
          
          # Add cards for each HTML file
          for file in examples/*.html; do
            if [ "$file" != "examples/index.html" ] && [ -f "$file" ]; then
              filename=$(basename "$file")
              title="${filename%.html}"
              cat >> examples/index.html << EOF
              <div class="example-card">
                <h3>${title}</h3>
                <p><a href="${filename}">View Example â†’</a></p>
              </div>
          EOF
            fi
          done
          
          cat >> examples/index.html << EOF
            </div>
            <div class="timestamp">
              <p>Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')</p>
              <p><a href="https://github.com/Gilead-BioStats/gsm.kri">View Repository</a></p>
            </div>
          </body>
          </html>
          EOF
    
      - name: Commit and push to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ steps.target.outputs.dir }}/"
          if [ "${{ steps.target.outputs.is_pr }}" == "true" ]; then
            git commit -m "Update examples for PR #${{ steps.target.outputs.pr_number }} from ${{ github.sha }}" || echo "No changes to commit"
          else
            git commit -m "Update examples from ${{ github.sha }}" || echo "No changes to commit"
          fi
          git push origin gh-pages || git push origin gh-pages --force
      
      - name: Comment on PR with examples link
        if: steps.target.outputs.is_pr == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = ${{ github.event.pull_request.number }};
            const examples_url = `https://gilead-biostats.github.io/gsm.kri/examples/pr-${pr_number}/`;
            
            // Check if we have any examples
            const fs = require('fs');
            const path = require('path');
            const examplesDir = `examples/pr-${pr_number}`;
            
            let hasExamples = false;
            try {
              const files = fs.readdirSync(examplesDir);
              hasExamples = files.some(f => f.endsWith('.html'));
            } catch (e) {
              console.log('No examples directory found');
            }
            
            if (hasExamples) {
              const comment = `## ðŸ“Š Example Outputs\n\nThe examples have been generated and are available at:\n\n${examples_url}\n\n*Examples will be automatically removed when this PR is closed.*`;
              
              // Check if we already commented
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr_number,
              });
              
              const botComment = comments.find(c => 
                c.user.login === 'github-actions[bot]' && 
                c.body.includes('Example Outputs')
              );
              
              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment,
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr_number,
                  body: comment,
                });
              }
            }
