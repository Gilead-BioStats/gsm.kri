---
title: "Calculating Site Risk Scores"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Calculating Site Risk Scores}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Overview

This vignette describes how **site-level risk scores** are calculated using Key Risk Indicators (KRIs), their associated *flags*, and predefined *weights* for those flags. The risk scoring framework provides a standardized, quantitative way to highlight sites with elevated risk.

# Risk Indicators and Flags

Each KRI (e.g., Adverse Events, Serious Adverse Events, Protocol Deviations) in the `gsm` framework is assigned a *flag* as part of the [standard analysis workflow](https://gilead-biostats.github.io/gsm.core/articles/DataAnalysis.html). Flags can also be associated with a *weight*, which reflects their contribution to site risk. For example, a site with a low adverse event rate could present more risk than a site with a low query rate. While both KRIs could have the same `flag` value (e.g. -2, representing low rates compared to other sites)  a higher *weight* could be assigned to the AE KRI flag than the query rate KRI flag. Default flag weights for the 12 standard `gsm` are shown below. 
  
```{r, echo=FALSE}
library(knitr)

kri_weights <- data.frame(
  KRI = c("Adverse Event", "Serious Adverse Event", "Protocol Deviations", "Important Protocol Deviations",
          "Labs", "Query Rate", "Delayed Query Rate", "Delayed Data Entry Rate", "Data Change Rate", "Screen Failure",
          "Treatment Discontinuation", "Study Discontinuation"),
  Low_Red   = c(32, 8, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0),
  Low_Amber = c(16, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0),
  High_Amber= c(1, 4, 8, 16, 1, 1, 1, 1, 1, 8, 16, 16),
  High_Red  = c(2, 8, 16, 32, 2, 2, 2, 2, 2, 16, 32, 32)
)

kable(kri_weights, caption = "Flag Weights for Key Risk Indicators")
```

The `gsm.core::flag()` function is used to calculate site-level flag values and associated weights. Three key parameters are used in the site-risk score process: 

- `vThreshold` Vector of numeric values representing threshold values. Default is `c(-3,-2,2,3)` which is typical for z-scores.
- `vFlag` Vector of flag values. There must be one more item in Flag than thresholds - that is `length(vThreshold)+1 == length(vFlagValues)`. Default is `c(-2,-1,0,1,2)`, which is typical for z-scores.
- `vRiskScoreWeight` Vector of weights to apply to each flag value.  Default: `NULL`.

When `vRiskScoreWeight` is provided, the `Flag()` output will include additional columns capturing `Weight` and `MaxWeight` with the corresponding weight for each KRI. 

These parameters allow for flexible configuration of the relative risk for different metrics in a study. While simple examples can be run via direct calls to `Flag()`, [YAML workflows are recommended for reusable implementations](https://gilead-biostats.github.io/gsm.kri/articles/AddingKRIs.html). As such, all standard KRIs include default thresholds, flags and weights. The relevant sections of the [Adverse Event KRI YAML](https://github.com/Gilead-BioStats/gsm.kri/blob/main/inst/workflow/2_metrics/kri0001.yaml), including the default flag and weight values and `Flag()` function call are shown below for reference: 

```
meta:
  Type: Analysis
  ID: kri0001
  GroupLevel: Site
  Abbreviation: AE
  Metric: Adverse Event Rate
  Numerator: Adverse Events
  Denominator: Days on Study
  Model: Normal Approximation
  Score: Adjusted Z-Score
  AnalysisType: rate
  Threshold: -2,-1,2,3
  Flag: "-2,-1,0,1,2"
  RiskScoreWeight: "32,16,0,1,2"
  ...
steps:
  - output: vThreshold
    name: gsm.core::ParseThreshold
    params:
      strThreshold: Threshold
  - output: vRiskScoreWeight
    name: gsm.core::ParseThreshold
    params:
      strThreshold: RiskScoreWeight
      bSort: false
  - output: vFlag
    name: gsm.core::ParseThreshold
    params:
      strThreshold: Flag
      bSort: false
  ... 
  - output: Analysis_Flagged
    name: gsm.core::Flag
    params:
      dfAnalyzed: Analysis_Analyzed
      vThreshold: vThreshold
      vFlag: vFlag
      vRiskScoreWeight: vRiskScoreWeight
      nAccrualThreshold: AccrualThreshold
      strAccrualMetric: AccrualMetric
  ...
```


# Site Risk Score Calculation

Once all metrics are run, a **site risk score** is calculated by taking the sum of the weights associated for each KRI. Below is a worked example for one site:
  
```{r, echo=FALSE}
site_example <- data.frame(
  KRI = c("Adverse Event", "Serious Adverse Event", "Protocol Deviations", "Important Protocol Deviations",
          "Labs", "Query Rate", "Delayed Query Rate", "Delayed Data Entry Rate", "Data Change Rate",
          "Screen Failure", "Treatment Discontinuation", "Study Discontinuation"),
  Flag= c(-2,0,-1,0,0,1,0,0,0,1,0,0),
  Contribution = c(32, 0, 4, 0, 0, 1, 0, 0, 0, 8, 0, 0)
)

kable(site_example, caption = "Example Site Contributions to Risk Score")
```

These weights are added up at the site level and divided by the maximum possible score to create a **normalized risk score** between 0 and 100. This normalized site risk score is what is reported in the KRI report, and if desired, any sites above a certain threshold can be flagged for further review.
  
```{r}
normalized_score <- (sum(site_example$Contribution)/178) * 100
normalized_score
```

The `gsm.kri::CalculateRiskScore()` function and associated Site Risk Score workflow (saved as `inst/workflows/metrics/SRS0001.yaml`) simplifies this process when using standard YAML workflows. In short, `CalculateRiskScore` takes a `data.frames`created by `Flag()` containing site-level KRI results  that include the `Weight` and `MaxWeight` columns described above and computes a new metric that saves the the normalized risk score for each site automatically. 

When available the standard KRI report produced by `Report_KRI.R` includes a column showing the normalized site-risk score for each site. 

# Benchmarking Across Sites

Site-level scores can be contextualized in two ways:
  
* **Relative ranking**: comparing each siteâ€™s score against other sites (e.g., percentile, rank order).
* **Temporal comparison**: computing scores across multiple months to understand site-level fluctuations.

# Conclusion
  
This scoring framework provides an interpretable, quantitative measure of risk at each site. By combining information across KRIs and weighting severity appropriately, it allows data monitoring teams to identify high-risk sites and prioritize monitoring resources effectively.

